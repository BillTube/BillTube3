BTFW.define("feature:styleCore",[],async () =>{function ensureSlate(){const links = Array.from(document.querySelectorAll('link[rel="stylesheet"]'));const hasBootSlate = links.some(l => /(bootstrap.*\.css|bootswatch.*slate)/i.test(l.href || ""));if (!hasBootSlate && !document.querySelector('link[data-btfw-slate]')){const s = document.createElement("link");s.rel = "stylesheet";s.href = "https://cdn.jsdelivr.net/npm/bootswatch@3.4.1/slate/bootstrap.min.css";s.dataset.btfwSlate = "1";document.head.insertBefore(s,document.head.firstChild);}}// --- UI deps + z-index layering (once) --- function ensureUiDepsAndZ(){if (!document.querySelector('link[href*="bulma.min.css"]') && !document.querySelector('link[data-btfw-bulma]')){const l = document.createElement('link');l.rel = 'stylesheet';l.href = 'https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css';l.dataset.btfwBulma = "1";document.head.appendChild(l);}if (!document.querySelector('link[data-btfw-fa6]') && !document.querySelector('link[href*="fontawesome"]')){const fa = document.createElement("link");fa.rel = "stylesheet";fa.href = "https://cdn.jsdelivr.net/gh/ElBeyonder/font-awesome-6.5.2-pro-full@master/css/all.css";fa.dataset.btfwFa6 = "1";document.head.appendChild(fa);}// Global z-index fixes + userlist overlay default CLOSED if (!document.getElementById('btfw-modal-zfix-core')){const z = document.createElement('style');z.id = 'btfw-modal-zfix-core';z.textContent = ` #nav-collapsible,.navbar,#navbar,.navbar-fixed-top{position:sticky !important;top:0;left:0;right:0;z-index:5000 !important;}.modal{z-index:6000 !important;}.modal .modal-background{z-index:6001 !important;}.modal .modal-card,.modal .modal-content{z-index:6002 !important;}#userlist.btfw-userlist-overlay:not(.btfw-userlist-overlay--open){display:none !important;}`;document.head.appendChild(z);}}ensureSlate();setTimeout(ensureSlate,400);ensureUiDepsAndZ();setTimeout(ensureUiDepsAndZ,300);// Persist "fluid" layout so CyTube renders consistently for all users try{localStorage.setItem("cytube-layout","fluid");localStorage.setItem("layout","fluid");if (typeof window.setPreferredLayout === "function"){window.setPreferredLayout("fluid");}}catch (e){}return{name:"feature:styleCore"};});BTFW.define("feature:bulma-layer",[],async () =>{// Persisted preference (kept for Theme Settings compatibility) const KEY = "btfw:theme:mode";// "auto" | "dark" | "light" const KEY_OLD = "btfw:bulma:theme";// legacy key support const mq = window.matchMedia && window.matchMedia("(prefers-color-scheme:dark)");// Single style injector for all dark-scope rules let styleEl;function ensureStyle(){if (styleEl) return styleEl;styleEl = document.createElement("style");styleEl.id = "btfw-bulma-dark-bridge";document.head.appendChild(styleEl);return styleEl;}// Dark theme CSS (Bulma surfaces + Bootstrap/CyTube modal bridge),scoped to data-btfw-theme="dark" const DARK_CSS = ` html[data-btfw-theme="dark"]{color-scheme:dark;}html[data-btfw-theme="dark"],html[data-btfw-theme="dark"] body{background:var(--btfw-color-bg);color:var(--btfw-color-text);}html[data-btfw-theme="dark"] body{background-image:none;}html[data-btfw-theme="dark"] .content,html[data-btfw-theme="dark"] .title,html[data-btfw-theme="dark"] .subtitle,html[data-btfw-theme="dark"] p,html[data-btfw-theme="dark"] small{color:var(--btfw-color-text);}html[data-btfw-theme="dark"] .box,html[data-btfw-theme="dark"] .card,html[data-btfw-theme="dark"] .panel,html[data-btfw-theme="dark"] .menu,html[data-btfw-theme="dark"] .notification,html[data-btfw-theme="dark"] .dropdown-content,html[data-btfw-theme="dark"] .modal-card{background:color-mix(in srgb,var(--btfw-color-surface) 92%,transparent 8%) !important;color:var(--btfw-color-text) !important;border:1px solid var(--btfw-border) !important;box-shadow:0 18px 42px color-mix(in srgb,var(--btfw-color-bg) 55%,transparent 45%);}html[data-btfw-theme="dark"] .tabs.is-boxed li a{background:transparent;border-color:transparent;color:#c8d4e0;}html[data-btfw-theme="dark"] .tabs.is-boxed li.is-active a{background:color-mix(in srgb,var(--btfw-color-panel) 82%,transparent 18%);color:var(--btfw-color-text);border-color:var(--btfw-border);}html[data-btfw-theme="dark"] .input,html[data-btfw-theme="dark"] .textarea,html[data-btfw-theme="dark"] .select select{background:color-mix(in srgb,var(--btfw-color-panel) 94%,transparent 6%) !important;color:var(--btfw-color-text) !important;border-color:color-mix(in srgb,var(--btfw-border) 80%,transparent 20%) !important;}html[data-btfw-theme="dark"] .input::placeholder,html[data-btfw-theme="dark"] .textarea::placeholder{color:color-mix(in srgb,var(--btfw-color-text) 55%,transparent 45%) !important;}html[data-btfw-theme="dark"] .button,html[data-btfw-theme="dark"] .btn{background:color-mix(in srgb,var(--btfw-color-panel) 88%,transparent 12%);color:var(--btfw-color-text);border:1px solid color-mix(in srgb,var(--btfw-border) 70%,transparent 30%);}html[data-btfw-theme="dark"] .button:hover,html[data-btfw-theme="dark"] .btn:hover{filter:brightness(1.05);}html[data-btfw-theme="dark"] .button.is-link,html[data-btfw-theme="dark"] .button.is-primary{background:color-mix(in srgb,var(--btfw-color-accent) 82%,transparent 18%) !important;border-color:color-mix(in srgb,var(--btfw-color-accent) 68%,transparent 32%) !important;color:var(--btfw-color-on-accent) !important;}html[data-btfw-theme="dark"] #chatwrap,html[data-btfw-theme="dark"] #messagebuffer{background:transparent;}html[data-btfw-theme="dark"] .modal{z-index:6000 !important;}html[data-btfw-theme="dark"] .modal .modal-background{background-color:color-mix(in srgb,var(--btfw-color-bg) 88%,transparent 12%) !important;}html[data-btfw-theme="dark"] .modal-card-head,html[data-btfw-theme="dark"] .modal-card-foot{background-color:color-mix(in srgb,var(--btfw-color-panel) 92%,transparent 8%) !important;border-color:var(--btfw-border) !important;color:var(--btfw-color-text) !important;}html[data-btfw-theme="dark"] .modal-card{background-color:color-mix(in srgb,var(--btfw-color-surface) 94%,transparent 6%) !important;color:var(--btfw-color-text) !important;}html[data-btfw-theme="dark"] .modal-card-title{color:var(--btfw-color-text) !important;}html[data-btfw-theme="dark"] .modal.fade,html[data-btfw-theme="dark"] .modal.in,html[data-btfw-theme="dark"] .modal{z-index:6000 !important;}html[data-btfw-theme="dark"] .modal-backdrop{background-color:color-mix(in srgb,var(--btfw-color-bg) 88%,transparent 12%) !important;z-index:0 !important;}html[data-btfw-theme="dark"] .modal-dialog{max-width:880px;}html[data-btfw-theme="dark"] .modal-content{background-color:color-mix(in srgb,var(--btfw-color-surface) 94%,transparent 6%) !important;color:var(--btfw-color-text) !important;border:1px solid var(--btfw-border) !important;}@media screen and (min-width:769px){.modal-card,.modal-content{width:44rem;}}html[data-btfw-theme="dark"] .modal-header,html[data-btfw-theme="dark"] .modal-footer{background-color:color-mix(in srgb,var(--btfw-color-panel) 92%,transparent 8%) !important;border-color:var(--btfw-border) !important;color:var(--btfw-color-text) !important;}html[data-btfw-theme="dark"] .modal-title{color:var(--btfw-color-text) !important;}html[data-btfw-theme="dark"] .modal .btn-primary{background:color-mix(in srgb,var(--btfw-color-accent) 82%,transparent 18%) !important;border-color:color-mix(in srgb,var(--btfw-color-accent) 68%,transparent 32%) !important;color:var(--btfw-color-on-accent) !important;}html[data-btfw-theme="dark"] .modal .btn-default{background:color-mix(in srgb,var(--btfw-color-panel) 88%,transparent 12%) !important;border-color:color-mix(in srgb,var(--btfw-border) 70%,transparent 30%) !important;color:var(--btfw-color-text) !important;}body.modal-open{overflow:hidden;}`;// Color-scheme meta for proper form controls on some browsers function ensureColorSchemeMeta(mode){const desired = (mode === "dark") ? "dark":"light";let meta = document.querySelector('meta[name="color-scheme"]');if (!meta){meta = document.createElement("meta");meta.setAttribute("name","color-scheme");document.head.appendChild(meta);}meta.setAttribute("content",desired);}// Pref read/write (with backward compatibility) function readPref(){try{const v = localStorage.getItem(KEY);if (v) return v;const legacy = localStorage.getItem(KEY_OLD);return legacy || "dark";}catch (_){return "dark";}}function writePref(v){try{localStorage.setItem(KEY,v);}catch(_){}}// Compute effective mode if "auto" function resolveAuto(){return (mq && mq.matches) ? "dark":"light";}// Apply theme & CSS bridge function apply(mode){const effective = (mode === "auto") ? resolveAuto():(mode || "dark");const html = document.documentElement;html.setAttribute("data-btfw-theme",effective);html.classList.toggle("btfw-theme-dark",effective === "dark");// keep compatibility with your CSS ensureColorSchemeMeta(effective);// Inject or clear dark CSS const st = ensureStyle();st.textContent = (effective === "dark") ? DARK_CSS:"";}// Public API function setTheme(mode){const m = (mode === "auto" || mode === "dark" || mode === "light") ? mode:"dark";writePref(m);apply(m);}function getTheme(){return readPref();}// React to OS scheme while in Auto function wireAutoWatcher(){if (!mq || !mq.addEventListener) return;mq.addEventListener("change",() =>{if (getTheme() === "auto") apply("auto");});}// Boot function boot(){apply(readPref());// default dark if unset wireAutoWatcher();// live-update if system scheme changes}if (document.readyState === "loading") document.addEventListener("DOMContentLoaded",boot);else boot();return{name:"feature:bulma-layer",setTheme,getTheme};});BTFW.define("feature:bulma",["feature:bulma-layer"],async ({}) => ({name:"feature:bulma"}));BTFW.define("feature:layout",["feature:styleCore","feature:bulma"],async ({}) =>{const SPLIT_KEY = "btfw:grid:leftPx";const CHAT_SIDE_KEY = "btfw:layout:chatSide";const MOBILE_STACK_ID = "btfw-mobile-stack";const NAV_HOST_ID = "btfw-navhost";const VIDEO_MIN_PX = 520;const DEFAULT_VIDEO_TARGET = 680;const CHAT_MIN_PX = 360;const WIDTH_BUFFER = 20;const MOBILE_THRESHOLD_MIN = 900;const MOBILE_THRESHOLD_MAX = 940;let videoColumnPx = null;let chatSidePref = "right";let isVertical = false;let mobileToggleEl = null;function refreshVideoSizing(){const wrap = document.getElementById("videowrap");if (!wrap) return;wrap.querySelectorAll("iframe,video").forEach(el =>{el.style.removeProperty("height");el.style.removeProperty("width");el.style.removeProperty("maxHeight");});const vjs = wrap.querySelector(".video-js");if (vjs){const player = vjs.player || vjs.player_ || (window.videojs && (window.videojs.players?.[vjs.id] || window.videojs(vjs.id)));if (player){try{if (typeof player.trigger === "function") player.trigger("componentresize");if (player.tech_ && typeof player.tech_.trigger === "function") player.tech_.trigger("resize");if (typeof player.resize === "function") player.resize();}catch (_){}}}}function getStoredChatSide(){try{const stored = localStorage.getItem(CHAT_SIDE_KEY);return stored === "left" ? "left":"right";}catch (_){return "right";}}function loadVideoColumnWidth(){try{const saved = parseInt(localStorage.getItem(SPLIT_KEY) || "",10);if (!isNaN(saved) && saved >= VIDEO_MIN_PX){videoColumnPx = saved;}}catch (_){videoColumnPx = null;}}function applyColumnTemplate(){const grid = document.getElementById("btfw-grid");if (!grid) return;if (isVertical){grid.style.gridTemplateColumns = "";grid.classList.remove("btfw-grid--chat-left","btfw-grid--chat-right");return;}const stored = videoColumnPx ? Math.max(videoColumnPx,VIDEO_MIN_PX):null;const fallbackVideo = `minmax(${VIDEO_MIN_PX}px,7fr)`;const fallbackChat = "minmax(var(--btfw-chat-min,320px),3fr)";const videoSegment = stored ? `minmax(${VIDEO_MIN_PX}px,${stored}px)`:fallbackVideo;const chatSegment = stored ? "minmax(var(--btfw-chat-min,320px),1fr)":fallbackChat;const template = chatSidePref === "left" ? `${chatSegment}var(--btfw-split-width,8px) ${videoSegment}`:`${videoSegment}var(--btfw-split-width,8px) ${chatSegment}`;grid.style.gridTemplateColumns = template;grid.classList.toggle("btfw-grid--chat-left",chatSidePref === "left");grid.classList.toggle("btfw-grid--chat-right",chatSidePref !== "left");}function setVideoColumnWidth(px){if (!Number.isFinite(px)) return;const width = Math.max(px,VIDEO_MIN_PX);videoColumnPx = width;try{localStorage.setItem(SPLIT_KEY,String(width));}catch (_){}applyColumnTemplate();}function computeThreshold(){const stored = Math.max(videoColumnPx || DEFAULT_VIDEO_TARGET,VIDEO_MIN_PX);const comfortable = stored + CHAT_MIN_PX + WIDTH_BUFFER;return Math.min( Math.max(comfortable,MOBILE_THRESHOLD_MIN),MOBILE_THRESHOLD_MAX );}function ensureMobileStackShell(){let shell = document.getElementById(MOBILE_STACK_ID);if (!shell){shell = document.createElement("div");shell.id = MOBILE_STACK_ID;shell.className = "btfw-mobile-stack";shell.innerHTML = ` <div class="btfw-mobile-stack__panel" role="dialog" aria-modal="true" aria-labelledby="btfw-mobile-stack-title"> <div class="btfw-mobile-stack__header"> <span class="btfw-mobile-stack__title" id="btfw-mobile-stack-title">Modules</span> <button type="button" class="btfw-mobile-stack__close" aria-label="Close modules">&times;</button> </div> <div class="btfw-mobile-stack__body"></div> </div> `;document.body.appendChild(shell);shell.addEventListener("click",(ev) =>{if (ev.target === shell) setMobileStackOpen(false);});const closeBtn = shell.querySelector(".btfw-mobile-stack__close");if (closeBtn) closeBtn.addEventListener("click",() => setMobileStackOpen(false));if (!document._btfwMobileStackEsc){document._btfwMobileStackEsc = true;document.addEventListener("keydown",(ev) =>{if (ev.key === "Escape") setMobileStackOpen(false);});}}return shell;}function isMobileStackOpen(){const shell = document.getElementById(MOBILE_STACK_ID);return !!(shell && shell.classList.contains("btfw-mobile-stack--open"));}function placeStackInLayout(){const stack = document.getElementById("btfw-stack");if (!stack) return;if (isVertical){stack.classList.add("btfw-stack--in-chat");const chatcol = document.getElementById("btfw-chatcol");if (!chatcol) return;const chatwrap = document.getElementById("chatwrap");if (chatwrap && chatwrap.parentElement === chatcol){if (chatwrap.nextSibling !== stack){chatcol.insertBefore(stack,chatwrap.nextSibling);}}else if (stack.parentElement !== chatcol){chatcol.appendChild(stack);}}else{stack.classList.remove("btfw-stack--in-chat");const left = document.getElementById("btfw-leftpad");if (!left) return;const video = document.getElementById("videowrap");if (video && video.parentElement === left){if (video.nextSibling !== stack){if (video.nextSibling) left.insertBefore(stack,video.nextSibling);else left.appendChild(stack);}}else if (stack.parentElement !== left){left.appendChild(stack);}}}function setMobileStackOpen(open){const shell = ensureMobileStackShell();const allow = !!open && isVertical;if (allow) moveStackToOverlay();else restoreStackFromOverlay();shell.classList.toggle("btfw-mobile-stack--open",allow);if (document.body){document.body.classList.toggle("btfw-mobile-stack-open",allow);}const toggle = document.getElementById("btfw-mobile-modules-toggle");if (toggle) toggle.setAttribute("aria-expanded",allow ? "true":"false");}function moveStackToOverlay(){if (!isVertical) return;const stack = document.getElementById("btfw-stack");if (!stack) return;const shell = ensureMobileStackShell();const body = shell.querySelector(".btfw-mobile-stack__body");if (body && stack.parentElement !== body){stack.classList.remove("btfw-stack--in-chat");body.appendChild(stack);}}function restoreStackFromOverlay(){placeStackInLayout();}function wireMobileToggle(){const toggle = document.getElementById("btfw-mobile-modules-toggle");if (!toggle || toggle === mobileToggleEl) return;mobileToggleEl = toggle;toggle.setAttribute("aria-expanded","false");toggle.setAttribute("aria-haspopup","dialog");toggle.addEventListener("click",(ev) =>{ev.preventDefault();if (!isVertical){toggle.blur();return;}setMobileStackOpen(!isMobileStackOpen());});}function updateResponsiveLayout(){const grid = document.getElementById("btfw-grid");if (!grid) return;wireMobileToggle();const shouldVertical = window.innerWidth < computeThreshold();if (shouldVertical !== isVertical){isVertical = shouldVertical;grid.classList.toggle("btfw-grid--vertical",shouldVertical);if (document.body){document.body.classList.toggle("btfw-mobile-stack-enabled",shouldVertical);}if (shouldVertical){if (isMobileStackOpen()) moveStackToOverlay();else restoreStackFromOverlay();}else{setMobileStackOpen(false);restoreStackFromOverlay();}refreshVideoSizing();setTimeout(() =>{refreshVideoSizing();try{window.dispatchEvent(new Event("resize"));}catch (_){}},60);document.dispatchEvent(new CustomEvent("btfw:layout:orientation",{detail:{vertical:shouldVertical}}));}else{if (shouldVertical){if (isMobileStackOpen()) moveStackToOverlay();else restoreStackFromOverlay();}else{restoreStackFromOverlay();}}applyColumnTemplate();setTop();if (!shouldVertical) refreshVideoSizing();}function setTop(){const header = document.querySelector(".navbar,#nav-collapsible,#navbar,.navbar-fixed-top");const h = header ? header.offsetHeight:48;const newTop = h + "px";// Update CSS custom property document.documentElement.style.setProperty("--btfw-top",newTop);// Force layout recalculation for sticky elements const chatcol = document.getElementById("btfw-chatcol");if (chatcol){if (isVertical){chatcol.style.top = "0px";chatcol.style.height = "";}else{chatcol.style.top = `calc(${newTop}+ var(--btfw-gap))`;chatcol.style.height = `calc(100vh - ${newTop}- var(--btfw-gap) * 2)`;}}}function makeResizable(){const grid = document.getElementById("btfw-grid");const splitter = document.getElementById("btfw-vsplit");if (!grid || !splitter){console.warn("[BTFW] Resizer elements not found.");return;}let isResizing = false;splitter.addEventListener("mousedown",(e) =>{if (isVertical) return;isResizing = true;e.preventDefault();// Add a class to the body to prevent text selection during drag document.body.classList.add("btfw-resizing");document.addEventListener("mousemove",handleMouseMove);document.addEventListener("mouseup",stopResize);});function handleMouseMove(e){if (!isResizing || isVertical) return;const gridRect = grid.getBoundingClientRect();const splitRect = splitter.getBoundingClientRect();const splitWidth = splitRect.width || parseFloat(getComputedStyle(splitter).width) || 6;let newVideoWidth;if (chatSidePref === "left"){const pointerX = e.clientX - gridRect.left;const chatWidth = Math.max(pointerX - splitWidth / 2,0);const available = gridRect.width - chatWidth - splitWidth;if (available < VIDEO_MIN_PX || chatWidth < CHAT_MIN_PX) return;newVideoWidth = available;}else{newVideoWidth = e.clientX - gridRect.left;const chatWidthCandidate = gridRect.width - newVideoWidth - splitWidth;if (newVideoWidth < VIDEO_MIN_PX || chatWidthCandidate < CHAT_MIN_PX) return;}if (!Number.isFinite(newVideoWidth)) return;setVideoColumnWidth(newVideoWidth);}function stopResize(){if (!isResizing) return;isResizing = false;document.body.classList.remove("btfw-resizing");document.removeEventListener("mousemove",handleMouseMove);document.removeEventListener("mouseup",stopResize);updateResponsiveLayout();}}const BOOT=/^(col(-(xs|sm|md|lg|xl))?-(\d+|auto)|row|container(-fluid)?|pull-(left|right)|offset-\d+)$/;function stripDeep(root){if(!root) return;(root.classList||[]).forEach(c=>{if(BOOT.test(c)) root.classList.remove(c);});root.querySelectorAll("[class]").forEach(el=>{Array.from(el.classList).forEach(c=>{if(BOOT.test(c)) el.classList.remove(c);});});}function moveCurrent(){const vh = document.getElementById("videowrap-header");// If videowrap-header doesn't exist,that's okay - title might be created by CyTube later if (!vh){console.log('[layout] No videowrap-header found');return;}const ct = vh.querySelector("#currenttitle");const top = document.querySelector("#chatwrap .btfw-chat-topbar");if (top){let slot = top.querySelector("#btfw-nowplaying-slot");if (!slot){slot = document.createElement("div");slot.id = "btfw-nowplaying-slot";slot.className = "btfw-chat-title";top.innerHTML = "";top.appendChild(slot);}// If currenttitle exists,move it if (ct){slot.appendChild(ct);console.log('[layout] Moved #currenttitle to slot');}else{console.log('[layout] No #currenttitle found in videowrap-header');}}// Only remove videowrap-header - the title is either moved or wasn't there vh.remove();}function ensureShell(){const wrap=document.getElementById("wrap")||document.body;const v=document.getElementById("videowrap");const c=document.getElementById("chatwrap");const q=document.getElementById("playlistrow")||document.getElementById("playlistwrap")||document.getElementById("queuecontainer");if(!document.getElementById("btfw-grid")){const grid=document.createElement("div");grid.id="btfw-grid";const left=document.createElement("div");left.id="btfw-leftpad";const right=document.createElement("aside");right.id="btfw-chatcol";if(v) left.appendChild(v);if(q) left.appendChild(q);if(c) right.appendChild(c);const split=document.createElement("div");split.id="btfw-vsplit";ensureNavHost(grid);grid.appendChild(left);grid.appendChild(split);grid.appendChild(right);// Insert grid but keep it hidden until properly sized grid.style.opacity = '0';wrap.prepend(grid);}else{const left=document.getElementById("btfw-leftpad");const right=document.getElementById("btfw-chatcol");const v=document.getElementById("videowrap");const c=document.getElementById("chatwrap");const q=document.getElementById("playlistrow")||document.getElementById("playlistwrap")||document.getElementById("queuecontainer");const grid=document.getElementById("btfw-grid");ensureNavHost(grid);if(v && !left.contains(v)) left.appendChild(v);if(q && !left.contains(q)) left.appendChild(q);if(c && !right.contains(c)) right.appendChild(c);}const leftpadWatch = document.getElementById("btfw-leftpad");if (leftpadWatch && !leftpadWatch._btfwStackWatch){const obs = new MutationObserver(() =>{if (isVertical){if (isMobileStackOpen()) moveStackToOverlay();else placeStackInLayout();}});obs.observe(leftpadWatch,{childList:true});leftpadWatch._btfwStackWatch = obs;}const chatWatch = document.getElementById("btfw-chatcol");if (chatWatch && !chatWatch._btfwStackWatch){const obs = new MutationObserver(() =>{if (isVertical && !isMobileStackOpen()) placeStackInLayout();});obs.observe(chatWatch,{childList:true});chatWatch._btfwStackWatch = obs;}["videowrap","playlistrow","playlistwrap","queuecontainer","queue","plmeta","chatwrap","controlsrow","rightcontrols"].forEach(id=>stripDeep(document.getElementById(id)));moveCurrent();placeStackInLayout();}function finishLayout(){const grid = document.getElementById("btfw-grid");if (grid){// Add loaded class and show grid grid.classList.add("btfw-loaded");grid.style.opacity = '1';}updateResponsiveLayout();document.dispatchEvent(new CustomEvent("btfw:layoutReady"));}function init(){ensureShell();loadVideoColumnWidth();chatSidePref = getStoredChatSide();applyColumnTemplate();setTop();updateResponsiveLayout();// Set up a more robust layout finalization const finalizeLayout = () =>{setTop();// Recalculate in case navbar mounted late makeResizable();finishLayout();};// Try multiple times to handle async loading setTimeout(finalizeLayout,100);setTimeout(finalizeLayout,300);setTimeout(finalizeLayout,600);// Also listen for window load as final fallback if (document.readyState === 'complete'){finalizeLayout();}else{window.addEventListener('load',finalizeLayout);}// Watch for navbar height changes const navbar = document.querySelector(".navbar,#nav-collapsible,#navbar,.navbar-fixed-top");if (navbar){const resizeObserver = new ResizeObserver(() =>{setTimeout(setTop,0);setTimeout(updateResponsiveLayout,0);});resizeObserver.observe(navbar);}// Watch for window resize window.addEventListener('resize',() =>{setTimeout(() =>{setTop();updateResponsiveLayout();},0);});}document.addEventListener("btfw:layout:chatSideChanged",(ev) =>{const side = ev && ev.detail && ev.detail.side === "left" ? "left":"right";chatSidePref = side;applyColumnTemplate();updateResponsiveLayout();});document.addEventListener("btfw:chat:barsReady",() =>{wireMobileToggle();if (isVertical){if (isMobileStackOpen()) moveStackToOverlay();else restoreStackFromOverlay();}});function findNavbarElement(){const selectors = [ "nav.navbar",".navbar-fixed-top","#navbar" ];for (const sel of selectors){const el = document.querySelector(sel);if (el) return el;}return null;}function ensureNavHost(grid){if (!grid) return;const navEl = findNavbarElement();if (!navEl) return;let host = document.getElementById(NAV_HOST_ID);if (!host){host = document.createElement("div");host.id = NAV_HOST_ID;host.className = "btfw-navhost";}if (navEl.parentElement !== host){host.appendChild(navEl);}if (host.parentElement !== grid){grid.insertBefore(host,grid.firstChild);}}if (document.readyState === "loading"){document.addEventListener("DOMContentLoaded",init);}else{init();}return{name:"feature:layout"};});function findNavbarElement(){const selectors = [ "nav.navbar",".navbar-fixed-top","#navbar" ];for (const sel of selectors){const el = document.querySelector(sel);if (el) return el;}return null;}// function ensureNavHost(grid){// if (!grid) return;// const navEl = findNavbarElement();// if (!navEl) return;// let host = document.getElementById(NAV_HOST_ID);// if (!host){// host = document.createElement("div");// host.id = NAV_HOST_ID;// host.className = "btfw-navhost";//}// if (navEl.parentElement !== host){// host.appendChild(navEl);//}// if (host.parentElement !== grid){// grid.insertBefore(host,grid.firstChild);//}//}